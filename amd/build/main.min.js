define(["jquery","core/modal_factory","core/templates","core/notification"],function(t,a,e,n){M.cfg.wwwroot;return{init:function(n){t(".block_boalist .one-resource").each(function(o,i){var r=t(this);r.find(".panel-cover").on("click",function(o){var i=r.data("modal");if(i)i.show();else{var c=t.get(r.data("about")).then(function(a,o,r){a.custom={},a.custom.preview=function(a){var e,n="";if(a.manifest.conexion_type&&"external"==a.manifest.conexion_type)return(e=t("<iframe></iframe>")).attr("src",a.manifest.url),$reslink=t('<p><a target="_blank"></a></p>'),$reslink.find("a").attr("href",a.manifest.url).html(a.manifest.url),e.get(0).outerHTML+$reslink.get(0).outerHTML;if(a.manifest.alternate&&a.manifest.entrypoint){var o=a.about+"/!/.alternate/"+a.manifest.entrypoint+"/";if(a.metadata.technical.format.match(/video/gi)||a.metadata.technical.format.match(/audio/gi)||a.metadata.technical.format.match(/image/gi)){var i=a.manifest.alternate.find(t=>/small/g.test(t));n=i?o+i:(i=a.manifest.alternate.find(t=>/medium/g.test(t)))?o+i:a.about+"/!/"+a.manifest.entrypoint}else n=(i=a.manifest.alternate.find(t=>/thumb/g.test(t)))?o+i:a.manifest.customicon}else n="technical"in a.metadata&&"format"in a.metadata.technical&&(a.metadata.technical.format.match(/video/gi)||a.metadata.technical.format.match(/audio/gi)||a.metadata.technical.format.match(/image/gi))?a.about+"/!/":a.manifest.customicon;return a.metadata.technical&&a.metadata.technical.format&&(a.metadata.technical.format.match(/video/gi)?(e=t("<video controls><source></source></video>")).find("source").attr("src",n).attr("type",a.metadata.technical.format):a.metadata.technical.format.match(/audio/gi)?(e=t("<audio controls><source></source></audio>")).find("source").attr("src",n).attr("type",a.metadata.technical.format):(e=t("<img />")).attr("src",n).attr("alt",a.metadata.general.title.none)),e.get(0).outerHTML}(a),a.custom.type=a.metadata.technical&&a.metadata.technical.format?a.metadata.technical.format:"",a.custom.score="avg"in a.social.score?a.social.score.avg+" / "+a.social.score.count:0,a.custom.downloadable=function(t){return!t.manifest.conexion_type||"external"!=t.manifest.conexion_type}(a);var c=[];return t.each(n,function(t,e){var n=e.url.replace("{url}",encodeURI(a.about+"/!/"));n=n.replace("{name}",a.metadata.general.title.none);var o={};o.url=n,o.icon=e.icon,c.push(o)}),a.custom.socialnetworks=c,a.custom.alternates=[],t.each(a.manifest.alternate,function(t,e){var n={text:"alternate_"+e.substring(0,e.indexOf("."))in M.str.block_boalist?M.str.block_boalist["alternate_"+e.substring(0,e.indexOf("."))]:e,url:a.about+"/!/.alternate/"+a.manifest.entrypoint+"/"+e};a.custom.alternates[a.custom.alternates.length]=n}),"object"==typeof a.metadata.general.keywords.none&&(a.metadata.general.keywords.none=a.metadata.general.keywords.none.join(", ")),e.render("block_boalist/viewresource",a).then(function(e,n){i.setTitle(a.metadata.general.title.none);var o=t(e);return o.find('[boa-act="rate"]').on("click",function(){var e=t(this),n={value:e.data("value")};t.post(a.about+"/scores",n,function(t){}).done(function(){o.find('[boa-act="rate"]').removeClass("active").each(function(a,n){var o=t(n);o.data("value")<=e.data("value")&&o.addClass("active")})})}),o}).promise()});t(o.currentTarget),a.create({body:c.promise()}).then(function(t){i=t,t.getModal().addClass("block_boalist-modal"),t.show(),r.data("modal",i)})}})})}}});